#
# Copyright (c) SAS Institute Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


class GroupRbuilderDist(GroupSetRecipe):
    name = 'group-rbuilder-dist'
    version = '8'

    unwantedComponents = ['devel', 'devellib', 'doc', 'build-tree', 'tk', 'test', 'gtk']

    def setup(r):
        r.dumpAll()
        r.makeSearchPath()
        addToMain = []

        vapp_core = r.troveFromMacro('vapp_label', 'group-standard-workgroup')
        core = r.troveFromMacro('distro_label', 'group-standard')
        core = core.makeOptional(core.find(
            'selinux-policy',
            'selinux-policy-targeted',
            )).update(vapp_core.find(
            'facter',
            'hiera',
            'info-puppet',
            'puppet',
            'ruby-augeas:ruby',
            'ruby-json:ruby',
            'ruby-shadow:ruby',
            'rubygem-json',
            )).update(r.mainSearchPath.find(
            'puppet-stdlib',
            ))
        # Flatten packages but don't strongly include components or the groups that were flattened
        vapp_core = vapp_core.flatten().getInstall()
        vapp_core -= vapp_core.findByName(r'group-.*|.*:.*')
        vapp_core -= vapp_core.find(
            'selinux-policy',
            'selinux-policy-targeted',
            # unneeded or not-working vapp stuff
            'conary-config-entitlement',
            'sasinside-appvirt-sasmanagementconsole',
            'sasinside-role-master',
            'sasinside-role-perfmonitor',
            'sasinside-role-router',
            'sasinside-role-uploader',
            'sasinside-thirdparty-webserver-sasrouter',
            # remove most stuff from group-rpath-core, the useful bits will be
            # added back from an in-tree source
            #'conary',
            #'libelf-lgpl',
            #'m2crypto-conary',
            #'openslp-conary',
            'open-vm-tools',
            #'python-conary',
            #'python-lxml-conary',
            #'pywbem-conary',
            #'rpath-models',
            #'rpath-tools',
            #'sblim-cmpi-base-conary',
            #'sblim-cmpi-devel-conary',
            #'sblim-cmpi-network-conary',
            #'sblim-sfcb-conary',
            #'sblim-sfcb-schema-conary',
            #'smartform-conary',
            #'smartform',
            # WORKAROUND for mismatched platform groups
            'nfs-utils',
            'openssl',
            'openssh-clients',
            'postfix',
            'rpm-python',
            'sudo',
            'sysstat',
            'wget',
            )
        system = r.mainSearchPath.find(
            'amiconfig',
            'amiconfig-vmwareguest',
            'conary',
            'dstat',
            'file',
            'keyutils',
            'krb5-workstation',
            'less',
            'lsof',
            'mailx',
            'nano',
            'nc',
            'net-snmp',
            'nfs-utils',
            'ntp',
            'ntpdate',
            'openssh-clients',
            'open-vm-tools',
            'pam_krb5',
            'patch',
            'patch',
            'postfix',
            'python-supervisor',
            'rdiff-backup',
            'rpath-tools',
            'rsync',
            'samba-common',
            'samba-winbind',
            'samba-winbind-clients',
            'screen',
            'sqlite',
            'strace',
            'sysstat',
            'tcpdump',
            'tinc',
            'vim-enhanced',
            'wget',
            'which',
            'ypbind',
            'yp-tools',
            )

        ## group-rbuilder-appliance
        rbuilder = r.mainSearchPath.find(
            # group-rbuilder-appliance
            'catalog-service',
            'conary-web-common',
            'gunicorn',
            'make',
            'nginx:distro',
            'nginx:runtime',
            'samba',
            'samba-winbind',
            'samba-common',
            'rmake',
            'rpath-repeater',
            'rbuilder',
            'rbuilder-ui',

            # Postgres
            'django-db-postgres',
            'postgresql92:bin',
            'python-pgsql',
            'python-psycopg2',
            'pgbouncer:runtime',

            # memcache
            'django-cache-memcached',
            'memcached',
            'python-memcached',

            # MCP
            'jabberd',
            'mcp',
            'mcp-server',

            # Jobmaster
            'jobmaster',
            'rbuilder-mcp',

            # rMake Multinode Server and Configuration.
            'rmake',
            'rmake-multinode-server',
            'rmake-node',
            'rmake3',
            'rmake3-multinode-server',
            'rmake3-node',
            'rpm-python',  # Fallback RPM
            'python-reportlab', # provides sgmlop, which makes rmake xmlrpc work better
            'group-rpm',
            )
        scripts = r.Scripts(
            preUpdate=r.Script(rba_prescript),
            postInstall=r.Script('#!/bin/bash\n'
                '/usr/share/rbuilder/scripts/post-install || exit 1\n'),
            postUpdate=r.Script('#!/bin/bash\n'
                '/usr/share/rbuilder/scripts/group-script || exit 1\n'),
            )

        rba = r.makeImageGroup('group-rbuilder-appliance', core + system + rbuilder, scripts=scripts)
        addToMain.append(rba)

        vapp = r.mainSearchPath.find(
            'sasinside-role-master-appengine',
            )
        vapp += vapp_core + system + rbuilder
        vapp = vapp.makeOptional(vapp.find('rbuilder:appliance'))  # omit static iptables rules, etc.
        rbv = r.makeImageGroup('group-rbuilder-vapp', vapp_core + system + rbuilder + vapp, scripts=scripts)
        addToMain.append(rbv)

        # add-on groups
        addToMain.append(r.makeZebra('group-ha', [
            'corosync',
            'crmsh',
            'drbd',
            'kernel-drbd',
            'pacemaker',
            'puppet-corosync',
            'rbuilder-ha',
            'resource-agents',
            ], rba))
        addToMain.append(r.makeZebra('group-entsrv', [
            'entsrv',
            ], rba))

        # extras
        # NB: These are not installed on the appliance, but kept to simplify
        # release management.
        extras = r.mainSearchPath.find(
            'anaconda-custom',
            ).makeOptional()
        addToMain.append(extras)

        ## group-rbuilder-dist -- just a bucket for the things created above
        main = addToMain.pop(0)
        for x in addToMain:
            main += x
        r.Group(main, checkPathConflicts=False)

    def makeImageGroup(r, name, troveset, scripts=None):
        troveset += troveset.depsNeeded(r.mainSearchPath)
        troveset = troveset.makeOptional(troveset.components(*r.unwantedComponents))
        return troveset.createGroup(name, scripts=scripts, imageGroup=True)

    def makeZebra(r, name, pkglist, base):
        "Make an add-on group for C{base} containing the packages named in C{pkglist}"
        stuff = r.mainSearchPath.find(*pkglist)
        stuff += (stuff + base).depsNeeded(r.mainSearchPath)
        stuff -= stuff.components(*r.unwantedComponents)
        return stuff.createGroup(name)

    def getAdditionalSearchPath(r):
        # Place new packages in the correct section, sorted alphabetically.
        packageSearchPath = []
        for macro, packages in [
                ('master_label', [
                        'amiconfig',
                        'amiconfig-vmwareguest',
                        'anaconda-custom',
                        'catalog-service',
                        'conary',
                        'conary-build',
                        'conary-policy',
                        'conary-repository',
                        'conary-rest',
                        'entsrv',
                        'entsrv-appliance',
                        'info-credstore',
                        'info-entsrv',
                        'jobmaster',
                        'jobslave',
                        'mcp',
                        'mcp-server',
                        'pcreator',
                        'pyovf',
                        'rbuilder',
                        'rbuilder-ha',
                        'rbuilder-mcp',
                        'rbuilder-ui',
                        'repodata',
                        'restlib',
                        'rmake',
                        'rmake3',
                        'rmake3-multinode-server',
                        'rmake3-node',
                        'rmake-multinode-server',
                        'rmake-node',
                        'robj',
                        'rpath-capsule-indexer',
                        'rpath-job',
                        'rpath-models',
                        'rpath-product-definition',
                        'rpath-repeater',
                        'rpath-storage',
                        'rpath-tools',
                        'rpath-xmllib',
                        'sasinside-role-master-appengine',
                        'smartform',
                        'wmiclient',
                        'xobj',
                      ]),
                ('aemon_label', [
                        'aemon',
                      ]),
                ]:
            label = r.macros.get(macro)
            if label is None:
                continue
            packageSearchPath.append(r.Repository(label, r.flavor
                ).find(*packages))
        return packageSearchPath

    def troveFromMacro(r, macro, troveName):
        item = r.macros[macro]
        if '=' not in item:
            item = troveName + '=' + item
        return r.Repository(r.macros.buildlabel, r.flavor).find(item)

    def getAppliancePlatformSearchPath(r):
        return [
            r.troveFromMacro('platform_label', 'group-rpath-platform'),
            r.troveFromMacro('common_label', 'group-rpath-packages'),
            r.troveFromMacro('distro_label', 'group-os'),
            ]

    def makeSearchPath(r):
        searchPath = r.getAdditionalSearchPath() + r.getAppliancePlatformSearchPath()
        r.mainSearchPath = r.SearchPath(*searchPath)
        return r.mainSearchPath


rba_prescript = '''\
#!/bin/sh

if pgrep corosync >/dev/null || pgrep crmd >/dev/null
then
    echo "Skipping preupdate script because it looks like we're in a cluster"
    exit 0
fi

# Stop cron before updates, it will be started again in the postupdate script.
# (RBL-7971)
[ -e /var/lock/subsys/crond ] && service crond stop || true
'''
