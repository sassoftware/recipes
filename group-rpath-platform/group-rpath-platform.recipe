#
# Copyright (c) 2010 rPath, Inc.
#
# All Rights Reserved
#

class GroupRbuilderDist(GroupRecipe):
    name = 'group-rpath-platform'
    version = '5.5.0'

    # group-rpath-platform is a trove bucket, not an image group, so disable
    # most checks.  See below for the actual image group definitions.
    imageGroup = False
    depCheck = False
    autoResolve = False
    checkPathConflicts = False

    packages = """
# rpl:2 packages rebuilt for python 2.6 support
nss=foresight.rpath.org@fl:2
nspr=foresight.rpath.org@fl:2
rpm=conary.rpath.com@rpl:2-py26-devel
# These are required by the rmake test suite
pygtk=foresight.rpath.org@fl:2
atk=foresight.rpath.org@fl:2
python-numeric=foresight.rpath.org@fl:2
cairo=foresight.rpath.org@fl:2
gtk=foresight.rpath.org@fl:2
glib=foresight.rpath.org@fl:2
libglade=foresight.rpath.org@fl:2
pango=foresight.rpath.org@fl:2
pixman=foresight.rpath.org@fl:2
pygobject=foresight.rpath.org@fl:2
gamin=foresight.rpath.org@fl:2

# Contrib packages
boto
bzr
django
django-cache-memcached
django-db-mysql
django-db-postgres
django-db-sqlite3
django-rest-interface
dstat
markdown
psycopg2
pyOpenSSL
python-ctypes
python-dateutil
python-memcached
python-twisted
python-txpostgres
python-wokkel
python-zopeinterface
pywbem
PyYAML
rdiff-backup
renderPM
reportlab
SQLAlchemy
vobject
webunit
XenAPI

# non-python contrib packages
cmake
dstat
ec2-ami-tools
git
iftop
info-jabber
info-nagios
iproute
jabberd
libevent
libgsasl
librsync
lzma
MochiKit
nagios-plugins
nrpe
perl-DBD-SQLite
squid
udns
xmlrpc-c
xz
yui

# postgres - we need both
postgresql=postgres.rpath.org@rpl:postgres-8.2-devel
postgresql=postgres.rpath.org@rpl:postgres-9.0-devel

# needed by conary's test suite
gcc-java=conary.rpath.com@rpl:2
unixODBC=conary.rpath.com@rpl:2
bitstream-vera-fonts=conary.rpath.com@rpl:2
"""

    def setup(r):
        r.setGroupSearchPath()
        #r.addAll('group-os', flatten=True)

        for pkg, versionStr in r.packageManifest:
            r.add(pkg, versionStr)

        r.addAll('group-rpm', 'rpm.rpath.org@rpath:linux-2-py26',
            flatten=True)

    def setGroupSearchPath(r):
        r.setSearchPath(
            'contrib.rpath.org@rpl:2-py26',
            'conary.rpath.com@rpl:2-py26-devel',
            'contrib.rpath.org@rpl:2',
        )

    @property
    def packageManifest(r):
        for pkg in r.packages.split('\n'):
            pkg = pkg.strip()
            if not pkg or pkg.startswith('#'):
                continue
            arr = pkg.split('=', 1)
            if len(arr) == 1:
                yield pkg, None
                continue
            yield arr[0], arr[1]
